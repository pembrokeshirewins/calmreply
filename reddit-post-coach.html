<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reddit Post Coach — CalmReply</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #f0f4f7;
      --card: #ffffff;
      --accent: #5a9ea6;
      --accent-hover: #4a8a91;
      --text: #2c3e50;
      --text-light: #6b7c8a;
      --border: #dce4ea;
      --success: #27ae60;
      --warning: #e67e22;
      --error: #c0625a;
      --radius: 12px;
      --shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    }

    html {
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding: 0 16px 48px;
    }

    /* ── Header ── */
    header {
      text-align: center;
      padding: 40px 0 8px;
    }

    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.02em;
    }

    header p {
      font-size: 1rem;
      color: var(--text-light);
      margin-top: 6px;
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
    }

    /* ── Screens ── */
    .screen {
      display: none;
      max-width: 600px;
      margin: 0 auto;
    }

    .screen.active {
      display: block;
    }

    /* ── Schedule Cards ── */
    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 24px;
    }

    .sub-card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px 24px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .sub-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .sub-card.next-up {
      border-color: var(--accent);
    }

    .sub-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .sub-card-name {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text);
    }

    .sub-card-members {
      font-size: 0.8rem;
      color: var(--text-light);
      font-weight: 400;
      margin-left: 6px;
    }

    .status-pill {
      display: inline-block;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 20px;
      white-space: nowrap;
    }

    .status-upcoming {
      background: var(--border);
      color: var(--text-light);
    }

    .status-draft-started {
      background: #fef3e2;
      color: var(--warning);
    }

    .status-ready {
      background: #e8f5e9;
      color: var(--success);
    }

    .status-posted {
      background: #e3f0f1;
      color: var(--accent);
    }

    .sub-card-meta {
      margin-top: 10px;
      font-size: 0.875rem;
      color: var(--text-light);
      line-height: 1.5;
    }

    .sub-card-meta .date {
      font-weight: 600;
      color: var(--text);
    }

    .sub-card-meta .angle {
      margin-top: 4px;
    }

    .sub-card-meta .flair {
      display: inline-block;
      margin-top: 6px;
      font-size: 0.75rem;
      background: var(--bg);
      padding: 2px 8px;
      border-radius: 6px;
      color: var(--text-light);
    }

    .next-label {
      display: inline-block;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .sub-card-word-range {
      font-size: 0.8rem;
      color: var(--text-light);
      margin-top: 4px;
    }

    .sub-card-link-strategy {
      font-size: 0.8rem;
      color: var(--text-light);
      margin-top: 2px;
    }

    /* ── Writer Screen ── */
    .writer-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--accent);
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px 0;
      margin-bottom: 12px;
    }

    .writer-back:hover {
      color: var(--accent-hover);
    }

    .writer-header {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px 24px;
      margin-top: 8px;
    }

    .writer-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }

    .writer-header-meta {
      font-size: 0.875rem;
      color: var(--text-light);
      line-height: 1.6;
    }

    .writer-header-meta .flair-tag {
      display: inline-block;
      font-size: 0.75rem;
      background: var(--bg);
      padding: 2px 8px;
      border-radius: 6px;
      color: var(--text-light);
      margin-top: 4px;
    }

    .writer-header-meta .link-strategy-note {
      display: block;
      margin-top: 6px;
      font-weight: 600;
      color: var(--accent);
      font-size: 0.8rem;
    }

    /* ── Cheat Sheet ── */
    .cheat-sheet {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-top: 16px;
    }

    .cheat-sheet summary {
      padding: 16px 24px;
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text);
      cursor: pointer;
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .cheat-sheet summary::-webkit-details-marker {
      display: none;
    }

    .cheat-sheet summary::after {
      content: '\25BC';
      font-size: 0.7rem;
      color: var(--text-light);
      transition: transform 0.2s ease;
    }

    .cheat-sheet[open] summary::after {
      transform: rotate(180deg);
    }

    .cheat-sheet-body {
      padding: 0 24px 20px;
    }

    .cheat-sheet-section {
      margin-bottom: 16px;
    }

    .cheat-sheet-section:last-child {
      margin-bottom: 0;
    }

    .cheat-sheet-section h4 {
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-light);
      margin-bottom: 6px;
    }

    .cheat-sheet-section ol,
    .cheat-sheet-section ul {
      padding-left: 20px;
      font-size: 0.875rem;
      line-height: 1.6;
      color: var(--text);
    }

    .cheat-sheet-section .hook-item {
      color: var(--accent);
      font-style: italic;
    }

    .do-dont-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .do-dont-grid ul {
      list-style: none;
      padding-left: 0;
      font-size: 0.85rem;
      line-height: 1.6;
    }

    .do-dont-grid .do-item {
      color: var(--success);
    }

    .do-dont-grid .dont-item {
      color: var(--error);
    }

    .cheat-sheet-section .comment-tone {
      font-size: 0.875rem;
      color: var(--text);
      font-style: italic;
    }

    /* ── Writer Inputs ── */
    .writer-inputs {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px 24px;
      margin-top: 16px;
    }

    .writer-inputs label {
      display: block;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-light);
      margin-bottom: 6px;
    }

    .writer-inputs input[type="text"],
    .writer-inputs textarea {
      display: block;
      width: 100%;
      font-family: inherit;
      font-size: 1rem;
      line-height: 1.6;
      color: var(--text);
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px 14px;
      transition: border-color 0.15s ease;
      resize: vertical;
    }

    .writer-inputs input[type="text"]:focus,
    .writer-inputs textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .writer-inputs .field-group {
      margin-bottom: 16px;
    }

    .writer-inputs .field-group:last-child {
      margin-bottom: 0;
    }

    .word-count {
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 6px;
    }

    .word-count.in-range {
      color: var(--success);
    }

    .word-count.near-range {
      color: var(--warning);
    }

    .word-count.out-of-range {
      color: var(--error);
    }

    /* ── Action Buttons ── */
    .writer-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .writer-actions button {
      flex: 1;
      min-width: 120px;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 700;
      padding: 12px 16px;
      border-radius: 8px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: opacity 0.15s ease;
    }

    .writer-actions button:hover {
      opacity: 0.85;
    }

    .btn-score {
      background: var(--accent);
      color: #fff;
    }

    .btn-generate {
      background: var(--text);
      color: #fff;
    }

    .btn-notion {
      background: #fff;
      color: var(--accent);
      border-color: var(--accent) !important;
    }

    /* ── Score Report ── */
    #scoreReport {
      margin-top: 16px;
    }

    .score-report-card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
    }

    .score-big {
      font-size: 2.5rem;
      font-weight: 700;
      text-align: center;
      line-height: 1.2;
    }

    .score-label {
      text-align: center;
      font-size: 0.95rem;
      font-weight: 600;
      margin-top: 4px;
      margin-bottom: 20px;
    }

    .score-category {
      border-top: 1px solid var(--border);
      padding-top: 14px;
      margin-top: 14px;
    }

    .score-category-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .score-category-name {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--text);
    }

    .score-category-weight {
      font-size: 0.75rem;
      color: var(--text-light);
    }

    .score-category-score {
      font-size: 0.875rem;
      font-weight: 700;
    }

    .score-check {
      font-size: 0.85rem;
      line-height: 1.7;
      padding-left: 4px;
    }

    .score-check-pass {
      color: var(--success);
    }

    .score-check-fail {
      color: var(--error);
    }

    /* ── Responsive ── */
    @media (max-width: 480px) {
      body {
        padding: 0 12px 40px;
      }

      header {
        padding: 28px 0 4px;
      }

      header h1 {
        font-size: 1.5rem;
      }

      .sub-card {
        padding: 16px 18px;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1>Reddit Post Coach</h1>
    <p>CalmReply launch campaign — write, score, and schedule Reddit posts.</p>
  </header>

  <!-- ── Schedule Screen ── -->
  <div id="schedule" class="screen active">
    <div class="schedule-list" id="schedule-list"></div>
  </div>

  <!-- ── Writer Screen ── -->
  <div id="writer" class="screen">
    <div id="writer-content"></div>
  </div>

  <script>
    // ════════════════════════════════════════════════════════════
    // Webhook URLs
    // ════════════════════════════════════════════════════════════
    var N8N_COACH_URL = 'https://aswales.app.n8n.cloud/webhook/calmreply-reddit-coach';
    var N8N_SAVE_URL = 'https://aswales.app.n8n.cloud/webhook/calmreply-reddit-save';

    // ════════════════════════════════════════════════════════════
    // Subreddit Intelligence Data
    // ════════════════════════════════════════════════════════════
    const SUBS = [
      {
        id: 'ADHD',
        name: 'r/ADHD',
        members: '2.2M',
        scheduledDate: '2026-02-24T11:30:00Z',
        angle: 'Question (avoidance stories)',
        flair: 'Seeking Empathy',
        wordCountMin: 200, wordCountMax: 400,
        linkStrategy: 'first-comment',
        keyPoints: [
          'Open with a relatable ADHD avoidance question — invite stories, not advice',
          'Paramedic context — the novelty/purpose match, the everything-else freeze',
          'Specific funny examples of procrastination from your life',
          'The ghosting dread — physical anxiety description (thump in the chest)',
          'Punchline: your most unhinged avoidance was building a tool to avoid the avoidance'
        ],
        provenHooks: [
          '"What\'s the most unhinged way you\'ve avoided a task"',
          '"I [embarrassing ADHD thing] and here\'s what happened"',
          '"Does anyone else [specific struggle]?"'
        ],
        killSignals: [
          { pattern: '\\b(AI|GPT|artificial intelligence|chatbot|language model)\\b', flags: 'i', message: 'AI mention detected — immediate suspicion in ND subs' },
          { pattern: '\\b(check out|try this|download|sign up|visit)\\b', flags: 'i', message: 'Promotional language detected' },
          { pattern: 'https?:\\/\\/|www\\.', flags: 'i', message: 'URL in post body — links go in first comment only' },
          { pattern: 'calm[\\s-]?reply', flags: 'i', message: 'Product name in post body — let them ask' }
        ],
        doList: [
          'Follow r/adhdwomen patterns but gender-neutral framing',
          'Personal story, first person, vulnerability > polish',
          'Show the struggle before any hint of a win',
          'End with a question that invites sharing'
        ],
        dontList: [
          'Don\'t mention building a tool in the title',
          'Don\'t use marketing language',
          'Don\'t post generic advice without lived experience',
          'Expect high removal risk — strict moderation (2.2M members)'
        ],
        commentTone: 'Casual, personal, empathetic. Match the energy of the community.',
        structureChecks: { requiresQuestion: true, requiresFirstPerson: true, requiresParamedic: false, requiresAuDHD: false }
      },
      {
        id: 'AutisticAdults',
        name: 'r/AutisticAdults',
        members: '~102K',
        scheduledDate: '2026-02-27T20:00:00Z',
        angle: 'Question (the freeze)',
        flair: '',
        wordCountMin: 50, wordCountMax: 200,
        linkStrategy: 'only-if-asked',
        keyPoints: [
          'The freeze moment — specific adult communication version: work emails, invoices, complaints',
          'Paramedic contrast — one sentence only: can handle emergencies, can\'t handle a passive-aggressive email',
          'The blank page insight — the freeze breaks when you have something to react to',
          'End with a question: "Does anyone else get this?"'
        ],
        provenHooks: [
          '"Does anyone else open a message, go completely blank, and then avoid it for a week?"',
          '"The freeze isn\'t about not knowing what to say"'
        ],
        killSignals: [
          { pattern: '\\b(AI|GPT|artificial intelligence|chatbot|language model)\\b', flags: 'i', message: 'AI mention detected' },
          { pattern: '\\b(check out|try this|download|sign up|visit)\\b', flags: 'i', message: 'Promotional language detected' },
          { pattern: 'https?:\\/\\/|www\\.', flags: 'i', message: 'URL in post body' },
          { pattern: 'calm[\\s-]?reply', flags: 'i', message: 'Product name in post body' },
          { pattern: '\\b(I built|I made|I created|free tool|my tool)\\b', flags: 'i', message: 'Tool/building language detected' }
        ],
        doList: [
          'Keep SHORT — 50-200 words, punchy',
          'Frame around adult communication challenges',
          'Describe the experience, not the tool',
          'End with a question'
        ],
        dontList: [
          'Don\'t mention building anything in the title',
          'Don\'t go over 200 words',
          'Don\'t describe how the tool works'
        ],
        commentTone: 'Practical, matter-of-fact, supportive.',
        structureChecks: { requiresQuestion: true, requiresFirstPerson: true, requiresParamedic: false, requiresAuDHD: false }
      },
      {
        id: 'autism',
        name: 'r/autism',
        members: '~492K',
        scheduledDate: '2026-03-02T14:30:00Z',
        angle: 'Question (blank page vs words)',
        flair: 'Discussion',
        wordCountMin: 200, wordCountMax: 350,
        linkStrategy: 'only-if-asked',
        keyPoints: [
          'Open with a question about the autistic processing experience — cognitive load of processing tone, intent, and response simultaneously',
          'Paramedic context — clinical emergencies are protocol-driven. Written communication has no protocol',
          'The blank page vs editing distinction — "I can edit a draft in minutes but can\'t start from nothing"',
          'Mention masking exhaustion — the freeze is worse after a full day of masking',
          'What do others do? — genuine question',
          'Don\'t describe the tool in the post'
        ],
        provenHooks: [
          '"Does anyone else find the blank page harder than the actual conversation?"',
          '"Reply paralysis: is it the words or the starting that\'s the problem?"'
        ],
        killSignals: [
          { pattern: '\\b(AI|GPT|artificial intelligence|chatbot|language model)\\b', flags: 'i', message: 'AI mention detected' },
          { pattern: '\\b(check out|try this|download|sign up|visit)\\b', flags: 'i', message: 'Promotional language detected' },
          { pattern: 'https?:\\/\\/|www\\.', flags: 'i', message: 'URL in post body' },
          { pattern: 'calm[\\s-]?reply', flags: 'i', message: 'Product name in post body' },
          { pattern: '\\bneurodivergent\\b', flags: 'i', message: 'Say "autistic" not "neurodivergent" — r/autism cares about specificity' },
          { pattern: '\\b(I built|I made|I created|free tool|my tool)\\b', flags: 'i', message: 'Tool/building language detected' }
        ],
        doList: [
          'Say "autistic" not "neurodivergent"',
          'Frame around the specific autistic processing experience',
          'Reference masking exhaustion',
          'Use appropriate flair',
          'Acknowledge the range of support needs'
        ],
        dontList: [
          'Don\'t be preachy or prescriptive',
          'Don\'t oversimplify the experience',
          'Don\'t ignore that some have the opposite problem (impulsive replies)',
          'Don\'t treat autism as a quirky personality trait'
        ],
        commentTone: 'Mix of intellectual engagement and personal sharing.',
        structureChecks: { requiresQuestion: true, requiresFirstPerson: true, requiresParamedic: true, requiresAuDHD: false }
      },
      {
        id: 'AutisticWithADHD',
        name: 'r/AutisticWithADHD',
        members: '~81K',
        scheduledDate: '2026-03-05T16:00:00Z',
        angle: 'The AuDHD communication conflict',
        flair: 'General Discussion',
        wordCountMin: 400, wordCountMax: 600,
        linkStrategy: 'first-comment',
        keyPoints: [
          'Name the AuDHD communication trap — ADHD wants to fire off an impulsive reply, autism needs to process for days',
          'Paramedic examples — real specific situations from your life',
          'What you tried that DIDN\'T work — templates? Scripts? Asking friends?',
          'The blank page realisation — frame as a discovery',
          'What you ended up building — describe functionally, don\'t name it, don\'t link it',
          'RSD disclaimer — "be brutal, the RSD will hit later" energy',
          'Open question — "Does the freeze work this way for you?"'
        ],
        provenHooks: [
          '"The AuDHD communication trap — my ADHD wants to reply NOW, my autism needs 3 days, and neither works"',
          '"AuDHD and the impossible message"'
        ],
        killSignals: [
          { pattern: '\\b(AI|GPT|artificial intelligence|chatbot|language model)\\b', flags: 'i', message: 'AI mention detected' },
          { pattern: '\\b(check out|try this|download|sign up|visit)\\b', flags: 'i', message: 'Promotional language detected' },
          { pattern: 'https?:\\/\\/|www\\.', flags: 'i', message: 'URL in post body' },
          { pattern: 'calm[\\s-]?reply', flags: 'i', message: 'Product name in post body' }
        ],
        doList: [
          'This is YOUR community — be fully authentic',
          'Go long (400-600 words)',
          'Address the specific AuDHD push-pull',
          'Include what didn\'t work before what did',
          'Be funny where it comes naturally'
        ],
        dontList: [
          'Don\'t rush — longest, most personal post',
          'Don\'t only address autism OR ADHD — the intersection is the point',
          'Don\'t make it about the tool'
        ],
        commentTone: 'Warm, detailed, personal. "Fellow AuDHD humans" energy.',
        structureChecks: { requiresQuestion: true, requiresFirstPerson: true, requiresParamedic: true, requiresAuDHD: true }
      },
      {
        id: 'aspergers',
        name: 'r/aspergers',
        members: '~175K',
        scheduledDate: '2026-03-12T17:30:00Z',
        angle: 'Observation (processing pattern)',
        flair: '',
        wordCountMin: 200, wordCountMax: 350,
        linkStrategy: 'only-if-asked',
        keyPoints: [
          'Open with an observation, not a feeling — "I\'ve noticed a pattern..."',
          'Describe the mechanism — cognitive processing load as a systems problem',
          'The blank page hypothesis — present as testable: "the bottleneck is initiation, not composition"',
          'Brief personal context — paramedic, on the spectrum. Factual, not emotional',
          'What you built, mechanically — how it works, not what it\'s called',
          'Invite analytical feedback — "Does this match your processing pattern?"'
        ],
        provenHooks: [
          '"I\'ve noticed a pattern in how I process difficult messages — the freeze isn\'t about the words"',
          '"Observation: the barrier to replying isn\'t finding the right words — it\'s starting from nothing"'
        ],
        killSignals: [
          { pattern: '\\b(AI|GPT|artificial intelligence|chatbot|language model)\\b', flags: 'i', message: 'AI mention detected' },
          { pattern: '\\b(check out|try this|download|sign up|visit)\\b', flags: 'i', message: 'Promotional language detected' },
          { pattern: 'https?:\\/\\/|www\\.', flags: 'i', message: 'URL in post body' },
          { pattern: 'calm[\\s-]?reply', flags: 'i', message: 'Product name in post body' },
          { pattern: '\\bneurodivergent\\b', flags: 'i', message: 'Say Asperger\'s or autistic, not neurodivergent' },
          { pattern: '\\bfree tool\\b', flags: 'i', message: '"Free tool" is product language' },
          { pattern: '\\bI felt\\b', flags: 'i', message: 'This sub prefers "I noticed" over emotional framing' }
        ],
        doList: [
          'Frame analytically — debate club, not support group',
          'Lead with mechanism: "I noticed..." not "I felt..."',
          'Use structured format (What / Why / How)',
          'Be honest about AI if asked',
          'Invite debate about the cognitive pattern'
        ],
        dontList: [
          'Don\'t use emotional hooks as primary framing',
          'Don\'t say "free tool" or "looking for feedback" in title',
          'Don\'t be paternalistic',
          'Don\'t use soft/emotional language as main hook'
        ],
        commentTone: 'Matter-of-fact, analytical, concise. Disagreement is normal here.',
        structureChecks: { requiresQuestion: true, requiresFirstPerson: true, requiresParamedic: true, requiresAuDHD: false }
      },
      {
        id: 'adhdwomen',
        name: 'r/adhdwomen',
        members: '~538K',
        scheduledDate: '2026-03-13T17:00:00Z',
        angle: 'Question (shame spiral)',
        flair: 'Emotional Regulation',
        wordCountMin: 300, wordCountMax: 400,
        linkStrategy: 'only-if-asked',
        keyPoints: [
          'Personal hook — a SPECIFIC freeze moment with physical feelings (chest tightens, stomach drops)',
          'The shame spiral — longer you leave it, worse the anxiety, more you hate yourself',
          'You\'re AuDHD and a paramedic — cardiac arrest vs email contrast',
          'What you tried that didn\'t work',
          'The blank page insight — personal discovery, NOT a tool pitch',
          '"Does anyone else experience this?" — DO NOT say "I built something"'
        ],
        provenHooks: [
          '"Does anyone else get the message freeze where you open it, panic, close it, and repeat for a week?"',
          '"I\'m so tired of the shame spiral from not replying to messages"',
          '"Does anyone else [specific struggle that sounds niche but is universal]?"'
        ],
        killSignals: [
          { pattern: '\\b(AI|GPT|artificial intelligence|chatbot|language model)\\b', flags: 'i', message: 'CRITICAL: r/adhdwomen BANS AI output (2,163 upvote mod post)' },
          { pattern: '\\b(check out|try this|download|sign up|visit|app|website)\\b', flags: 'i', message: 'CRITICAL: Hypervigilant about stealth advertising' },
          { pattern: 'https?:\\/\\/|www\\.', flags: 'i', message: 'CRITICAL: No URLs. Link ONLY if someone asks' },
          { pattern: 'calm[\\s-]?reply', flags: 'i', message: 'CRITICAL: Product name must NEVER appear' },
          { pattern: '\\b(I built|I made|I created|I found a tool|free tool|my tool|a tool)\\b', flags: 'i', message: 'CRITICAL: Do NOT mention building or finding a tool' },
          { pattern: '\\bfree\\b', flags: 'i', message: '"Free" implies product — remove it' }
        ],
        doList: [
          'This post is PURELY a personal story and a question',
          'Describe the physical feeling of the freeze',
          'Mention you\'re AuDHD and a paramedic',
          'Let the community ask what you do about it'
        ],
        dontList: [
          'DO NOT mention building anything',
          'DO NOT mention a tool, app, or website',
          'DO NOT link in post OR unprompted comment',
          'DO NOT say "I found something that helps"',
          'DO NOT use the word "free"',
          'DO NOT post on a Saturday'
        ],
        commentTone: 'Warm, personal, "omg same" energy. Lots of emojis. Tips shared casually.',
        structureChecks: { requiresQuestion: true, requiresFirstPerson: true, requiresParamedic: true, requiresAuDHD: true }
      },
      {
        id: 'neurodivergent',
        name: 'r/neurodivergent',
        members: '~14K',
        scheduledDate: '2026-03-18T17:30:00Z',
        angle: 'The cost of reply paralysis',
        flair: '',
        wordCountMin: 150, wordCountMax: 200,
        linkStrategy: 'first-comment',
        keyPoints: [
          'The cost of reply paralysis — lost friendships, damaged work relationships',
          'Brief context — AuDHD paramedic, one sentence',
          'The blank page insight — one or two sentences',
          'You built something for yourself — one sentence, don\'t describe features',
          'Open question — "Does reply paralysis hit anyone else this hard?"'
        ],
        provenHooks: [
          '"Reply paralysis has cost me friendships and I\'m tired of it"',
          '"Anyone else lose relationships because you can\'t make yourself reply?"'
        ],
        killSignals: [
          { pattern: '\\b(AI|GPT|artificial intelligence|chatbot|language model)\\b', flags: 'i', message: 'AI mention detected' },
          { pattern: '\\b(check out|try this|download|sign up|visit)\\b', flags: 'i', message: 'Promotional language detected' },
          { pattern: 'https?:\\/\\/|www\\.', flags: 'i', message: 'URL in post body' },
          { pattern: 'calm[\\s-]?reply', flags: 'i', message: 'Product name in post body' },
          { pattern: '\\b(free tool|communication tool)\\b', flags: 'i', message: 'Product Hunt language — say "a small thing I made"' }
        ],
        doList: [
          'Community-first: sharing, not announcing',
          'Keep concise — 150-200 words',
          'Lead with the cost/pain, not the solution'
        ],
        dontList: [
          'Don\'t list features',
          'Don\'t say "free" multiple times',
          'Don\'t make the title about the tool'
        ],
        commentTone: 'Warm, inclusive, community-oriented.',
        structureChecks: { requiresQuestion: true, requiresFirstPerson: true, requiresParamedic: false, requiresAuDHD: true }
      },
      {
        id: 'socialanxiety',
        name: 'r/socialanxiety',
        members: '~460K',
        scheduledDate: '2026-03-19T13:00:00Z',
        angle: 'Question (the freeze)',
        flair: 'Discussion',
        wordCountMin: 150, wordCountMax: 250,
        linkStrategy: 'only-if-asked',
        keyPoints: [
          'The universal freeze — NO ND language. Just: "You open a message, brain locks up, close it. Repeat for days"',
          'The shame compound — longer you leave it, worse it gets. Two sentences max',
          '"I recently figured something out" — blank page insight, keep it vague',
          'End with question — "Does anyone else experience this?" Full stop'
        ],
        provenHooks: [
          '"Does anyone else freeze when they need to reply to a difficult message?"',
          '"When you can\'t reply to a message and it ruins your whole day"'
        ],
        killSignals: [
          { pattern: '\\b(AI|GPT|artificial intelligence|chatbot|language model)\\b', flags: 'i', message: 'AI mention detected' },
          { pattern: '\\b(check out|try this|download|sign up|visit)\\b', flags: 'i', message: 'Promotional language detected' },
          { pattern: 'https?:\\/\\/|www\\.', flags: 'i', message: 'URL in post body' },
          { pattern: 'calm[\\s-]?reply', flags: 'i', message: 'Product name in post body' },
          { pattern: '\\b(I built|I made|I created|free tool|my tool|a tool)\\b', flags: 'i', message: 'Do NOT mention building anything' },
          { pattern: '\\b(autis|ADHD|AuDHD|neurodiverg|masking|stimming|RSD|rejection sensitiv)\\w*', flags: 'i', message: 'No ND language in r/socialanxiety — keep it universal' },
          { pattern: '\\b(you should|try this|have you tried)\\b', flags: 'i', message: 'No prescriptive advice' }
        ],
        doList: [
          'Universal anxiety framing — no ND identity',
          'Keep SHORT — under 250 words',
          'Use "Success" flair if sharing something helped',
          'Post the feeling, wait, share only when asked'
        ],
        dontList: [
          'DO NOT mention building anything',
          'DO NOT mention a tool in the post body',
          'DO NOT mention autism, ADHD, or neurodivergence',
          'DO NOT use clinical language',
          'DO NOT post a first comment with a link',
          'DO NOT use prescriptive language'
        ],
        commentTone: 'Quiet, empathetic, short. Don\'t force engagement.',
        structureChecks: { requiresQuestion: true, requiresFirstPerson: true, requiresParamedic: false, requiresAuDHD: false }
      }
    ];

    // ════════════════════════════════════════════════════════════
    // State Management
    // ════════════════════════════════════════════════════════════
    const STORAGE_KEY = 'reddit-coach';

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) return JSON.parse(raw);
      } catch (e) {
        console.warn('Failed to load state from localStorage:', e);
      }
      return null;
    }

    function saveState(state) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn('Failed to save state to localStorage:', e);
      }
    }

    function getState() {
      let state = loadState();
      if (!state || !state.posts) {
        state = { posts: {}, memory: [] };
        SUBS.forEach(function(sub) {
          state.posts[sub.id] = { status: 'upcoming', title: '', body: '', firstComment: '' };
        });
        saveState(state);
      }
      // Ensure all subs exist in state (in case new subs were added)
      SUBS.forEach(function(sub) {
        if (!state.posts[sub.id]) {
          state.posts[sub.id] = { status: 'upcoming', title: '', body: '', firstComment: '' };
        }
      });
      if (!state.memory) state.memory = [];
      return state;
    }

    // ════════════════════════════════════════════════════════════
    // Memory System
    // ════════════════════════════════════════════════════════════
    function getMemory() {
      var state = getState();
      return state.memory || [];
    }

    function addToMemory(subId, body) {
      var state = getState();
      if (!state.memory) state.memory = [];
      var found = false;
      for (var i = 0; i < state.memory.length; i++) {
        if (state.memory[i].subreddit === subId) {
          state.memory[i].body = body;
          found = true;
          break;
        }
      }
      if (!found) {
        state.memory.push({ subreddit: subId, body: body });
      }
      saveState(state);
    }

    // ════════════════════════════════════════════════════════════
    // Screen Navigation
    // ════════════════════════════════════════════════════════════
    function showScreen(id) {
      var screens = document.querySelectorAll('.screen');
      for (var i = 0; i < screens.length; i++) {
        screens[i].classList.remove('active');
      }
      var target = document.getElementById(id);
      if (target) target.classList.add('active');
    }

    // ════════════════════════════════════════════════════════════
    // Writer Screen
    // ════════════════════════════════════════════════════════════
    var currentSub = null;
    var autoSaveTimer = null;
    var lastScore = 0;

    function openWriter(subId) {
      // Find the sub in the SUBS array
      var sub = null;
      for (var i = 0; i < SUBS.length; i++) {
        if (SUBS[i].id === subId) {
          sub = SUBS[i];
          break;
        }
      }
      if (!sub) return;
      currentSub = sub;

      var state = getState();
      var post = state.posts[sub.id] || { status: 'upcoming', title: '', body: '', firstComment: '' };

      // Build link strategy text
      var linkNote = '';
      if (sub.linkStrategy === 'first-comment') {
        linkNote = 'Post link in first comment';
      } else {
        linkNote = 'ONLY share link if someone asks';
      }

      // Build first comment placeholder
      var firstCommentPlaceholder = '';
      if (sub.linkStrategy === 'first-comment') {
        firstCommentPlaceholder = 'Draft your first comment here — include a brief context and the link...';
      } else {
        firstCommentPlaceholder = 'Only post a comment with a link if someone explicitly asks...';
      }

      // ── Header ──
      var html = '';
      html += '<button class="writer-back" onclick="showScreen(\'schedule\'); renderSchedule();">';
      html += '&larr; Back to schedule</button>';

      html += '<div class="writer-header">';
      html += '<h2>' + sub.name + '</h2>';
      html += '<div class="writer-header-meta">';
      html += '<div>' + formatDate(sub.scheduledDate) + '</div>';
      html += '<div>' + sub.wordCountMin + '&ndash;' + sub.wordCountMax + ' words</div>';
      if (sub.flair) {
        html += '<span class="flair-tag">Flair: ' + sub.flair + '</span>';
      }
      html += '<span class="link-strategy-note">' + linkNote + '</span>';
      html += '</div></div>';

      // ── Cheat Sheet ──
      html += '<details class="cheat-sheet">';
      html += '<summary>Cheat Sheet</summary>';
      html += '<div class="cheat-sheet-body">';

      // Key points
      html += '<div class="cheat-sheet-section">';
      html += '<h4>Key Points to Hit</h4>';
      html += '<ol>';
      for (var k = 0; k < sub.keyPoints.length; k++) {
        html += '<li>' + sub.keyPoints[k] + '</li>';
      }
      html += '</ol></div>';

      // Proven hooks
      html += '<div class="cheat-sheet-section">';
      html += '<h4>Proven Hooks</h4>';
      html += '<ul>';
      for (var h = 0; h < sub.provenHooks.length; h++) {
        html += '<li class="hook-item">' + sub.provenHooks[h] + '</li>';
      }
      html += '</ul></div>';

      // Kill signals
      html += '<div class="cheat-sheet-section">';
      html += '<h4>Kill Signals</h4>';
      html += '<ul>';
      for (var ks = 0; ks < sub.killSignals.length; ks++) {
        html += '<li class="dont-item">' + sub.killSignals[ks].message + '</li>';
      }
      html += '</ul></div>';

      // DO / DON'T grid
      html += '<div class="cheat-sheet-section">';
      html += '<h4>Do / Don\'t</h4>';
      html += '<div class="do-dont-grid">';
      html += '<ul>';
      for (var d = 0; d < sub.doList.length; d++) {
        html += '<li class="do-item">' + sub.doList[d] + '</li>';
      }
      html += '</ul>';
      html += '<ul>';
      for (var n = 0; n < sub.dontList.length; n++) {
        html += '<li class="dont-item">' + sub.dontList[n] + '</li>';
      }
      html += '</ul>';
      html += '</div></div>';

      // Comment tone
      html += '<div class="cheat-sheet-section">';
      html += '<h4>Comment Tone</h4>';
      html += '<p class="comment-tone">' + sub.commentTone + '</p>';
      html += '</div>';

      html += '</div></details>';

      // ── Input Area ──
      html += '<div class="writer-inputs">';

      // Title
      html += '<div class="field-group">';
      html += '<label for="postTitle">Title</label>';
      html += '<input type="text" id="postTitle" placeholder="Lead with a feeling or question, not a product..." value="' + escapeAttr(post.title) + '" oninput="autoSaveDraft(); updateWordCount();">';
      html += '</div>';

      // Body
      html += '<div class="field-group">';
      html += '<label for="postBody">Body</label>';
      html += '<textarea id="postBody" rows="14" placeholder="Write your rough notes here..." oninput="autoSaveDraft(); updateWordCount();">' + escapeHtml(post.body) + '</textarea>';
      html += '<div class="word-count" id="wordCount">0 / ' + sub.wordCountMin + '&ndash;' + sub.wordCountMax + ' words</div>';
      html += '</div>';

      // First comment
      html += '<div class="field-group">';
      html += '<label for="firstComment">First Comment</label>';
      html += '<textarea id="firstComment" rows="3" placeholder="' + escapeAttr(firstCommentPlaceholder) + '" oninput="autoSaveDraft();">' + escapeHtml(post.firstComment) + '</textarea>';
      html += '</div>';

      html += '</div>';

      // ── Action Buttons ──
      html += '<div class="writer-actions">';
      html += '<button class="btn-score" onclick="scoreDraft();">Score My Draft</button>';
      html += '<button class="btn-generate" id="btnGenerate" onclick="doItForMe();">Do It For Me</button>';
      html += '<button class="btn-notion" id="btnSave" onclick="saveToNotion();">Save to Notion</button>';
      html += '</div>';

      // ── Score Report ──
      html += '<div id="scoreReport"></div>';

      // Render
      document.getElementById('writer-content').innerHTML = html;
      showScreen('writer');

      // Update word count on load
      updateWordCount();
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function escapeAttr(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function countWords(text) {
      if (!text || !text.trim()) return 0;
      return text.trim().split(/\s+/).length;
    }

    function updateWordCount() {
      if (!currentSub) return;
      var body = document.getElementById('postBody');
      var countEl = document.getElementById('wordCount');
      if (!body || !countEl) return;

      var count = countWords(body.value);
      var min = currentSub.wordCountMin;
      var max = currentSub.wordCountMax;

      // Determine colour class
      var cls = 'out-of-range';
      if (count >= min && count <= max) {
        cls = 'in-range';
      } else {
        // Within 30% of bounds = amber
        var lowerBound = Math.floor(min * 0.7);
        var upperBound = Math.ceil(max * 1.3);
        if (count >= lowerBound && count <= upperBound) {
          cls = 'near-range';
        }
      }

      countEl.className = 'word-count ' + cls;
      countEl.innerHTML = count + ' / ' + min + '&ndash;' + max + ' words';
    }

    function autoSaveDraft() {
      if (autoSaveTimer) clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(function() {
        if (!currentSub) return;
        var title = document.getElementById('postTitle');
        var body = document.getElementById('postBody');
        var comment = document.getElementById('firstComment');

        var state = getState();
        var post = state.posts[currentSub.id];
        post.title = title ? title.value : '';
        post.body = body ? body.value : '';
        post.firstComment = comment ? comment.value : '';

        // Set status to draft-started if there is content
        if (post.title.trim() || post.body.trim() || post.firstComment.trim()) {
          if (post.status === 'upcoming') {
            post.status = 'draft-started';
          }
        }

        saveState(state);

        // Re-enable save button if it was left in "Saved!" state
        var saveBtn = document.getElementById('btnSave');
        if (saveBtn && saveBtn.disabled) {
          saveBtn.textContent = 'Save to Notion';
          saveBtn.style.background = '#fff';
          saveBtn.style.color = 'var(--accent)';
          saveBtn.style.borderColor = 'var(--accent)';
          saveBtn.disabled = false;
        }
      }, 1000);
    }

    // ── Scoring Engine ──
    function scoreDraft() {
      if (!currentSub) return;

      var title = (document.getElementById('postTitle').value || '').trim();
      var body = (document.getElementById('postBody').value || '').trim();
      var results = [];

      // ── 1. Title Quality (weight: 20%) ──
      var titleScore = 10;
      var titleChecks = [];
      if (!title) {
        titleScore = 0;
        titleChecks.push({ pass: false, message: 'Title is empty' });
      } else {
        // Promotional words
        var promoWords = ['free', 'tool', 'app', 'website', 'built', 'made', 'created', 'check out', 'try this', 'looking for feedback'];
        for (var p = 0; p < promoWords.length; p++) {
          var promoRe = new RegExp('\\b' + promoWords[p].replace(/\s+/g, '\\s+') + '\\b', 'i');
          if (promoRe.test(title)) {
            titleScore -= 3;
            titleChecks.push({ pass: false, message: 'Promotional word in title: "' + promoWords[p] + '"' });
          }
        }
        if (titleChecks.length === 0 || titleChecks.every(function(c) { return c.pass; })) {
          titleChecks.push({ pass: true, message: 'No promotional words in title' });
        }

        // Question/hook format
        var questionWordRe = /^(does|do|has|have|is|am|are|what|why|how|who|when|anyone)\b/i;
        if (title.indexOf('?') !== -1 || questionWordRe.test(title)) {
          titleChecks.push({ pass: true, message: 'Title uses question/hook format' });
        } else {
          titleScore -= 1;
          titleChecks.push({ pass: false, message: 'Consider starting with a question or "Does anyone else..."' });
        }

        // Title length
        if (title.length > 120) {
          titleScore -= 1;
          titleChecks.push({ pass: false, message: 'Title is over 120 characters (' + title.length + ')' });
        } else {
          titleChecks.push({ pass: true, message: 'Title length OK (' + title.length + ' chars)' });
        }
      }
      if (titleScore < 0) titleScore = 0;
      results.push({ name: 'Title Quality', weight: 20, score: titleScore, checks: titleChecks });

      // ── 2. Kill Signals (weight: 20%) ──
      var killScore = 10;
      var killChecks = [];
      var killSignals = currentSub.killSignals || [];
      for (var ks = 0; ks < killSignals.length; ks++) {
        var signal = killSignals[ks];
        var sigRe = new RegExp(signal.pattern, signal.flags);
        var foundIn = [];
        if (sigRe.test(title)) foundIn.push('title');
        if (sigRe.test(body)) foundIn.push('body');
        if (foundIn.length > 0) {
          killScore -= 3;
          killChecks.push({ pass: false, message: signal.message + ' (found in ' + foundIn.join(' and ') + ')' });
        }
      }
      if (killScore < 0) killScore = 0;
      if (killChecks.length === 0) {
        killChecks.push({ pass: true, message: 'No kill signals detected' });
      }
      results.push({ name: 'Kill Signals', weight: 20, score: killScore, checks: killChecks });

      // ── 3. Word Count (weight: 10%) ──
      var wordCount = countWords(body);
      var wcMin = currentSub.wordCountMin;
      var wcMax = currentSub.wordCountMax;
      var wcScore = 0;
      var wcChecks = [];
      if (wordCount === 0) {
        wcScore = 0;
        wcChecks.push({ pass: false, message: 'No post body written yet' });
      } else if (wordCount < wcMin) {
        wcScore = (wordCount < wcMin * 0.5) ? 2 : 5;
        wcChecks.push({ pass: false, message: wordCount + ' words — target is ' + wcMin + '\u2013' + wcMax + '. Add more detail' });
      } else if (wordCount > wcMax) {
        wcScore = (wordCount > wcMax * 1.5) ? 3 : 6;
        wcChecks.push({ pass: false, message: wordCount + ' words — target is ' + wcMin + '\u2013' + wcMax + '. Cut it down' });
      } else {
        wcScore = 10;
        wcChecks.push({ pass: true, message: wordCount + ' words — within target range (' + wcMin + '\u2013' + wcMax + ')' });
      }
      results.push({ name: 'Word Count', weight: 10, score: wcScore, checks: wcChecks });

      // ── 4. Structure (weight: 20%) ──
      var structScore = 10;
      var structChecks = [];
      var checks = currentSub.structureChecks || {};

      if (checks.requiresQuestion) {
        if (body.indexOf('?') !== -1) {
          structChecks.push({ pass: true, message: 'Body contains a question' });
        } else {
          structScore -= 3;
          structChecks.push({ pass: false, message: 'Body should contain a question' });
        }
      }

      if (checks.requiresFirstPerson) {
        var fpRe = /\bI\b/;
        if (fpRe.test(body)) {
          structChecks.push({ pass: true, message: 'First person voice detected' });
        } else {
          structScore -= 3;
          structChecks.push({ pass: false, message: 'Write in first person (use "I")' });
        }
      }

      if (checks.requiresParamedic) {
        var paramRe = /paramedic/i;
        if (paramRe.test(body)) {
          structChecks.push({ pass: true, message: 'Paramedic context included' });
        } else {
          structScore -= 2;
          structChecks.push({ pass: false, message: 'Mention being a paramedic' });
        }
      }

      if (checks.requiresAuDHD) {
        var audhdRe = /\b(AuDHD|autis\w+ (with|and) ADHD|ADHD (and|with) autis\w+)\b/i;
        if (audhdRe.test(body)) {
          structChecks.push({ pass: true, message: 'AuDHD identity mentioned' });
        } else {
          structScore -= 2;
          structChecks.push({ pass: false, message: 'Mention being AuDHD' });
        }
      }

      if (structScore < 0) structScore = 0;
      if (structChecks.length === 0) {
        structChecks.push({ pass: true, message: 'No structure requirements for this sub' });
      }
      results.push({ name: 'Structure', weight: 20, score: structScore, checks: structChecks });


      // ── 5. Link Discipline (weight: 10%) ──
      var linkScore = 10;
      var linkChecks = [];

      var urlRe = /https?:\/\/|www\./;
      if (urlRe.test(body)) {
        linkScore -= 5;
        linkChecks.push({ pass: false, message: 'URL found in post body' });
      }

      var productRe = /calm[\s-]?reply/i;
      if (productRe.test(body)) {
        linkScore -= 5;
        linkChecks.push({ pass: false, message: 'Product name found in post body' });
      }

      if (linkScore < 0) linkScore = 0;
      if (linkChecks.length === 0) {
        linkChecks.push({ pass: true, message: 'No links or product names in body' });
      }
      results.push({ name: 'Link Discipline', weight: 10, score: linkScore, checks: linkChecks });

      // ── 6. Voice & Authenticity (weight: 20%) ──
      var voiceScore = 5; // Start neutral — earn points for human, lose for AI
      var voiceChecks = [];

      if (body) {
        // --- AI TELL PATTERNS (penalise) ---

        // Em dash overuse (AI signature)
        var emDashCount = (body.match(/\u2014/g) || []).length;
        if (emDashCount >= 3) {
          voiceScore -= 2;
          voiceChecks.push({ pass: false, message: 'Heavy em dash usage (' + emDashCount + ' found) \u2014 classic AI writing pattern. Use commas, full stops, or "..." instead' });
        } else if (emDashCount >= 1) {
          voiceScore -= 1;
          voiceChecks.push({ pass: false, message: 'Em dashes detected (' + emDashCount + ') \u2014 feels AI-generated. Real people use "..." or just commas' });
        }

        // AI filler phrases
        var aiPhrases = [
          { re: /\b(here'?s the thing|let me be clear|it'?s worth noting|the reality is|I'?ll be honest)\b/gi, label: 'AI opener phrases' },
          { re: /\b(at the end of the day|when all is said and done|in today'?s world)\b/gi, label: 'AI cliche phrases' },
          { re: /\b(navigate|resonate[sd]?|leverage[sd]?|dive into|deep dive|unpack)\b/gi, label: 'AI buzzwords (navigate, resonate, leverage, etc.)' },
          { re: /\b(incredibly|remarkably|genuinely|truly|absolutely|fundamentally)\b/gi, label: 'AI intensifiers used as filler' },
          { re: /\band that'?s okay\.?\b/gi, label: '"And that\'s okay" \u2014 AI therapy speak' },
          { re: /\b(it'?s important to|it'?s crucial to|it'?s essential to)\b/gi, label: 'AI prescriptive openers' },
          { re: /\b(I want to be transparent|I want to be vulnerable)\b/gi, label: 'Announcing vulnerability instead of being vulnerable' }
        ];
        var aiPhraseCount = 0;
        for (var ai = 0; ai < aiPhrases.length; ai++) {
          var matches = body.match(aiPhrases[ai].re);
          if (matches) {
            aiPhraseCount += matches.length;
            voiceChecks.push({ pass: false, message: aiPhrases[ai].label + ': "' + matches[0] + '"' });
          }
        }
        if (aiPhraseCount >= 3) {
          voiceScore -= 3;
        } else if (aiPhraseCount >= 1) {
          voiceScore -= 1;
        }

        // Short punchy paragraph pattern (AI staccato)
        var paragraphs = body.split(/\n\s*\n/);
        var shortParaCount = 0;
        for (var sp = 0; sp < paragraphs.length; sp++) {
          if (paragraphs[sp].trim() && countWords(paragraphs[sp]) <= 12) shortParaCount++;
        }
        if (paragraphs.length >= 4 && shortParaCount / paragraphs.length > 0.6) {
          voiceScore -= 1;
          voiceChecks.push({ pass: false, message: 'Too many short punchy paragraphs (' + shortParaCount + '/' + paragraphs.length + ') \u2014 reads like AI staccato. Real posts ramble more' });
        }

        // Overly clean structure (no sentence fragments, no trailing thoughts)
        var sentences = body.split(/[.!?]+/).filter(function(s) { return s.trim().length > 0; });
        var avgSentenceLen = 0;
        if (sentences.length > 0) {
          var totalWords = 0;
          for (var sl = 0; sl < sentences.length; sl++) totalWords += countWords(sentences[sl]);
          avgSentenceLen = totalWords / sentences.length;
        }
        if (avgSentenceLen > 18 && sentences.length > 5) {
          voiceScore -= 1;
          voiceChecks.push({ pass: false, message: 'Average sentence length is ' + Math.round(avgSentenceLen) + ' words \u2014 feels overly composed. Mix in some short fragments' });
        }

        // --- HUMAN MARKERS (reward) ---

        // Humour / personality indicators
        var humourMarkers = /\b(lol|lmao|haha|tbh|ngl)\b|\u{1F62C}|\u{1F605}|\u{1F62D}|\u{1F926}|:\)|;\)|:D|:P/gu;
        if (humourMarkers.test(body)) {
          voiceScore += 1;
          voiceChecks.push({ pass: true, message: 'Humour/personality markers found \u2014 feels human' });
        }

        // Self-deprecation (strong human signal)
        var selfDeprecation = /\b(embarrassing|cringe|terrible at|awful at|can'?t even|my brain just|I'?m the worst|I'?m so bad at|the irony|plot twist)\b/i;
        if (selfDeprecation.test(body)) {
          voiceScore += 1;
          voiceChecks.push({ pass: true, message: 'Self-deprecation detected \u2014 strong authenticity signal' });
        }

        // Specific lived details (places, times, people, numbers)
        var specificDetails = /\b(last (week|month|tuesday|wednesday|thursday|friday|monday)|the other day|at work|on shift|my (colleague|mate|friend|partner|boss|mum|dad)|[0-9]+ (hours|days|weeks|minutes|years))\b/i;
        if (specificDetails.test(body)) {
          voiceScore += 1;
          voiceChecks.push({ pass: true, message: 'Specific lived details found \u2014 anchors the story as real' });
        }

        // Physical sensation descriptions (high-performing in ND subs)
        var physicalSensations = /\b(chest tight|stomach drop|heart rac|palms|throat|physically|thump|punch in the gut|felt sick|couldn'?t breathe|froze|freezing)\b/i;
        if (physicalSensations.test(body)) {
          voiceScore += 1;
          voiceChecks.push({ pass: true, message: 'Physical sensation described \u2014 the top-performing posts in ND subs all do this' });
        }

        // Informal language / British English (authentic voice)
        var informalVoice = /\b(cos|gonna|kinda|wanna|innit|rubbish|bloody|arse|mate|sorted|reckon|proper|knackered|dodgy)\b|\.\.\./i;
        if (informalVoice.test(body)) {
          voiceScore += 1;
          voiceChecks.push({ pass: true, message: 'Informal/colloquial language \u2014 sounds like a real person, not a template' });
        }

        // Conversational markers
        var conversational = /\b(anyway|like,|honestly|I mean|you know what|if that makes sense|sorry for the ramble|idk)\b/i;
        if (conversational.test(body)) {
          voiceScore += 1;
          voiceChecks.push({ pass: true, message: 'Conversational tone markers \u2014 reads like someone actually talking' });
        }

        // No human markers at all
        if (voiceChecks.length === 0) {
          voiceScore -= 1;
          voiceChecks.push({ pass: false, message: 'No personality markers detected \u2014 add humour, specific details, or informal language to sound like yourself' });
        }
      } else {
        voiceScore = 0;
        voiceChecks.push({ pass: false, message: 'No body to check yet' });
      }

      if (voiceScore > 10) voiceScore = 10;
      if (voiceScore < 0) voiceScore = 0;
      results.push({ name: 'Voice & Authenticity', weight: 20, score: voiceScore, checks: voiceChecks });

      // ── Weighted total ──
      var weightedSum = 0;
      var weightTotal = 0;
      for (var r = 0; r < results.length; r++) {
        weightedSum += results[r].score * results[r].weight;
        weightTotal += results[r].weight;
      }
      var finalScore = Math.round((weightedSum / weightTotal) * 10) / 10;

      lastScore = finalScore;
      renderScoreReport(finalScore, results);
    }

    function renderScoreReport(score, results) {
      var el = document.getElementById('scoreReport');
      if (!el) return;

      // Determine colour and label
      var colour = '';
      var label = '';
      if (score >= 8) {
        colour = 'var(--success)';
        label = 'Ready to post';
      } else if (score >= 5) {
        colour = 'var(--warning)';
        label = 'Getting there';
      } else {
        colour = 'var(--error)';
        label = 'Needs work';
      }

      var html = '<div class="score-report-card">';

      // Big score number
      html += '<div class="score-big" style="color: ' + colour + ';">' + score.toFixed(1) + '/10</div>';
      html += '<div class="score-label" style="color: ' + colour + ';">' + label + '</div>';

      // Categories
      for (var i = 0; i < results.length; i++) {
        var cat = results[i];
        var catColour = cat.score >= 8 ? 'var(--success)' : (cat.score >= 5 ? 'var(--warning)' : 'var(--error)');

        html += '<div class="score-category">';
        html += '<div class="score-category-header">';
        html += '<span class="score-category-name">' + cat.name + ' <span class="score-category-weight">(' + cat.weight + '%)</span></span>';
        html += '<span class="score-category-score" style="color: ' + catColour + ';">' + cat.score + '/10</span>';
        html += '</div>';

        for (var c = 0; c < cat.checks.length; c++) {
          var check = cat.checks[c];
          if (check.pass) {
            html += '<div class="score-check score-check-pass">\u2713 ' + check.message + '</div>';
          } else {
            html += '<div class="score-check score-check-fail">\u2717 ' + check.message + '</div>';
          }
        }

        html += '</div>';
      }

      html += '</div>';
      el.innerHTML = html;

      // Scroll score report into view
      el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function doItForMe() {
      var btn = document.getElementById('btnGenerate');
      var originalText = btn.textContent;
      btn.textContent = 'Generating...';
      btn.disabled = true;

      try {
        var titleEl = document.getElementById('postTitle');
        var bodyEl = document.getElementById('postBody');
        var memory = getMemory();

        var response = await fetch(N8N_COACH_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subreddit: currentSub.id,
            userNotes: bodyEl.value,
            title: titleEl.value,
            previousPosts: memory
          })
        });

        if (!response.ok) {
          throw new Error('Server returned ' + response.status + ': ' + response.statusText);
        }

        var data = await response.json();

        if (data.title) {
          titleEl.value = data.title;
        }
        if (data.body) {
          bodyEl.value = data.body;
        }
        if (data.firstComment) {
          var commentEl = document.getElementById('firstComment');
          if (commentEl) commentEl.value = data.firstComment;
        }

        updateWordCount();

        if (data.notes) {
          var reportEl = document.getElementById('scoreReport');
          if (reportEl) {
            reportEl.innerHTML = '<div class="score-report-card" style="border-left: 4px solid var(--accent);">' +
              '<div style="font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; color: var(--accent); margin-bottom: 8px;">AI Notes</div>' +
              '<div style="font-size: 0.9rem; line-height: 1.6; color: var(--text); white-space: pre-wrap;">' + escapeHtml(data.notes) + '</div>' +
              '</div>';
          }
        }

        autoSaveDraft();
      } catch (err) {
        alert('Generation failed: ' + err.message);
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    async function saveToNotion() {
      var bodyEl = document.getElementById('postBody');
      var bodyText = bodyEl ? bodyEl.value.trim() : '';
      if (!bodyText) {
        alert('Write something first!');
        return;
      }

      var btn = document.getElementById('btnSave');
      var originalText = btn.textContent;
      var originalBg = btn.style.background;
      var originalColor = btn.style.color;
      var originalBorder = btn.style.borderColor;
      btn.textContent = 'Saving...';
      btn.disabled = true;

      try {
        var titleEl = document.getElementById('postTitle');
        var commentEl = document.getElementById('firstComment');
        var commentVal = commentEl ? commentEl.value.trim() : '';

        var response = await fetch(N8N_SAVE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subreddit: currentSub.name,
            scheduledDate: currentSub.scheduledDate,
            title: titleEl ? titleEl.value : '',
            body: bodyText,
            firstComment: commentVal || null,
            score: lastScore,
            linkStrategy: currentSub.linkStrategy
          })
        });

        if (!response.ok) {
          throw new Error('Server returned ' + response.status + ': ' + response.statusText);
        }

        var data = await response.json();

        // Update localStorage status to ready
        var state = getState();
        if (state.posts[currentSub.id]) {
          state.posts[currentSub.id].status = 'ready';
          saveState(state);
        }

        // Add to memory
        addToMemory(currentSub.id, bodyText);

        // Style button as success
        btn.textContent = 'Saved!';
        btn.style.background = 'var(--success)';
        btn.style.color = '#fff';
        btn.style.borderColor = 'var(--success)';

        // Append Notion link if present
        if (data.notionUrl) {
          var linkEl = document.createElement('a');
          linkEl.href = data.notionUrl;
          linkEl.target = '_blank';
          linkEl.rel = 'noopener noreferrer';
          linkEl.textContent = 'Open in Notion';
          linkEl.style.cssText = 'display: block; text-align: center; margin-top: 8px; font-size: 0.875rem; font-weight: 600; color: var(--accent);';
          btn.parentNode.insertBefore(linkEl, btn.nextSibling);
        }
      } catch (err) {
        alert('Save failed: ' + err.message);
        btn.textContent = originalText;
        btn.style.background = originalBg;
        btn.style.color = originalColor;
        btn.style.borderColor = originalBorder;
        btn.disabled = false;
      }
    }

    // ════════════════════════════════════════════════════════════
    // Schedule Dashboard
    // ════════════════════════════════════════════════════════════
    function formatDate(isoString) {
      var d = new Date(isoString);
      var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      var day = days[d.getUTCDay()];
      var date = d.getUTCDate();
      var month = months[d.getUTCMonth()];
      var hours = d.getUTCHours();
      var minutes = d.getUTCMinutes();
      var ampm = hours >= 12 ? 'pm' : 'am';
      hours = hours % 12;
      if (hours === 0) hours = 12;
      var minuteStr = minutes < 10 ? '0' + minutes : '' + minutes;
      return day + ' ' + date + ' ' + month + ' at ' + hours + ':' + minuteStr + ampm + ' GMT';
    }

    function getStatusClass(status) {
      switch (status) {
        case 'draft-started': return 'status-draft-started';
        case 'ready': return 'status-ready';
        case 'posted': return 'status-posted';
        default: return 'status-upcoming';
      }
    }

    function getStatusLabel(status) {
      switch (status) {
        case 'draft-started': return 'Draft Started';
        case 'ready': return 'Ready';
        case 'posted': return 'Posted';
        default: return 'Upcoming';
      }
    }

    function renderSchedule() {
      var state = getState();
      var list = document.getElementById('schedule-list');
      list.innerHTML = '';

      // Sort subs by scheduled date
      var sorted = SUBS.slice().sort(function(a, b) {
        return new Date(a.scheduledDate) - new Date(b.scheduledDate);
      });

      // Find first upcoming (not posted, not ready) sub
      var nextUpId = null;
      for (var i = 0; i < sorted.length; i++) {
        var postState = state.posts[sorted[i].id];
        if (postState && postState.status !== 'posted' && postState.status !== 'ready') {
          nextUpId = sorted[i].id;
          break;
        }
      }

      for (var j = 0; j < sorted.length; j++) {
        var sub = sorted[j];
        var post = state.posts[sub.id] || { status: 'upcoming' };
        var isNext = sub.id === nextUpId;

        var card = document.createElement('div');
        card.className = 'sub-card' + (isNext ? ' next-up' : '');
        card.setAttribute('data-sub-id', sub.id);
        card.addEventListener('click', (function(id) {
          return function() { openWriter(id); };
        })(sub.id));

        var html = '';

        if (isNext) {
          html += '<div class="next-label">Write this one next</div>';
        }

        html += '<div class="sub-card-header">';
        html += '<span><span class="sub-card-name">' + sub.name + '</span>';
        html += '<span class="sub-card-members">' + sub.members + '</span></span>';
        html += '<span class="status-pill ' + getStatusClass(post.status) + '">' + getStatusLabel(post.status) + '</span>';
        html += '</div>';

        html += '<div class="sub-card-meta">';
        html += '<div class="date">' + formatDate(sub.scheduledDate) + '</div>';
        html += '<div class="angle">' + sub.angle + '</div>';
        html += '<div class="sub-card-word-range">' + sub.wordCountMin + '–' + sub.wordCountMax + ' words &middot; Link: ' + sub.linkStrategy + '</div>';
        if (sub.flair) {
          html += '<span class="flair">' + sub.flair + '</span>';
        }
        html += '</div>';

        card.innerHTML = html;
        list.appendChild(card);
      }
    }

    // ════════════════════════════════════════════════════════════
    // Init
    // ════════════════════════════════════════════════════════════
    renderSchedule();
  </script>
</body>
</html>
