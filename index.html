<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CalmReply — Handles the conversations you've been avoiding</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #f0f4f7;
      --card: #ffffff;
      --accent: #5a9ea6;
      --accent-hover: #4a8a91;
      --accent-active: #3d747a;
      --text: #2c3e50;
      --text-light: #6b7c8a;
      --border: #dce4ea;
      --success: #5a9ea6;
      --error: #c0625a;
      --radius: 12px;
      --shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    }

    html {
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding: 0 16px 48px;
    }

    /* ── Header ── */
    header {
      text-align: center;
      padding: 40px 0 8px;
    }

    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.02em;
    }

    header p {
      font-size: 1rem;
      color: var(--text-light);
      margin-top: 6px;
      max-width: 360px;
      margin-left: auto;
      margin-right: auto;
    }

    /* ── Card ── */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-width: 540px;
      margin: 24px auto 0;
      padding: 28px 24px;
    }

    /* ── Form Elements ── */
    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }

    select,
    textarea {
      width: 100%;
      font-family: inherit;
      font-size: 1rem;
      color: var(--text);
      background: var(--card);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 12px 14px;
      transition: border-color 0.2s;
      appearance: none;
      -webkit-appearance: none;
    }

    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='none'%3E%3Cpath d='M1 1.5l5 5 5-5' stroke='%236b7c8a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
      cursor: pointer;
    }

    textarea {
      resize: vertical;
      min-height: 140px;
    }

    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .field + .field {
      margin-top: 20px;
    }

    /* ── Tone Pills ── */
    .tone-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .tone-pill {
      position: relative;
    }

    .tone-pill input {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .tone-pill span {
      display: inline-block;
      font-size: 0.85rem;
      font-weight: 500;
      padding: 7px 16px;
      border-radius: 20px;
      border: 1.5px solid var(--border);
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
      -webkit-user-select: none;
    }

    .tone-pill input:checked + span {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .tone-pill span:hover {
      border-color: var(--accent);
    }

    /* ── Primary Button ── */
    .btn-primary {
      display: block;
      width: 100%;
      margin-top: 24px;
      padding: 16px;
      font-family: inherit;
      font-size: 1.05rem;
      font-weight: 600;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-primary:active {
      background: var(--accent-active);
      transform: scale(0.985);
    }

    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    /* ── Output Area ── */
    .output-section {
      display: none;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .output-section.visible {
      display: block;
    }

    .output-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 10px;
    }

    .output-text {
      font-size: 0.95rem;
      line-height: 1.7;
      color: var(--text);
      white-space: pre-wrap;
      word-wrap: break-word;
      background: #f7fafb;
      border-radius: 8px;
      padding: 16px;
      border: 1px solid var(--border);
    }

    .btn-copy {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 14px;
      padding: 10px 20px;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent);
      background: transparent;
      border: 1.5px solid var(--accent);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-copy:hover {
      background: var(--accent);
      color: #fff;
    }

    .btn-copy.copied {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    /* ── Error Message ── */
    .error-msg {
      display: none;
      margin-top: 16px;
      padding: 12px 16px;
      font-size: 0.9rem;
      color: var(--error);
      background: #fdf0ef;
      border-radius: 8px;
      text-align: center;
    }

    .error-msg.visible {
      display: block;
    }

    /* ── Email Capture ── */
    .email-section {
      max-width: 540px;
      margin: 32px auto 0;
      text-align: center;
      padding: 0 4px;
    }

    .email-section p {
      font-size: 0.9rem;
      color: var(--text-light);
      line-height: 1.55;
      max-width: 420px;
      margin: 0 auto 14px;
    }

    .email-form {
      display: flex;
      gap: 8px;
      max-width: 420px;
      margin: 0 auto;
    }

    .email-form input {
      flex: 1;
      min-width: 0;
      font-family: inherit;
      font-size: 0.95rem;
      padding: 12px 14px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      background: var(--card);
      transition: border-color 0.2s;
    }

    .email-form input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .email-form input::placeholder {
      color: #a0adb8;
    }

    .email-form button {
      flex-shrink: 0;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      padding: 12px 18px;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .email-form button:hover {
      background: var(--accent-hover);
    }

    .email-confirm {
      display: none;
      font-size: 0.9rem;
      color: var(--accent);
      font-weight: 500;
      margin-top: 10px;
    }

    .email-confirm.visible {
      display: block;
    }

    /* ── Footer ── */
    footer {
      text-align: center;
      margin-top: 40px;
      padding: 0 4px;
    }

    footer p {
      font-size: 0.8rem;
      color: var(--text-light);
      line-height: 1.5;
    }

    /* ── Responsive ── */
    @media (max-width: 400px) {
      body {
        padding: 0 12px 40px;
      }

      .card {
        padding: 22px 18px;
      }

      header h1 {
        font-size: 1.5rem;
      }

      .email-form {
        flex-direction: column;
      }

      .email-form button {
        width: 100%;
      }
    }
    /* ── Feedback ── */
    .feedback-section {
      display: none;
      margin-top: 16px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
    }

    .feedback-section.visible {
      display: block;
    }

    .feedback-prompt {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .feedback-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .feedback-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 7px 14px;
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-light);
      background: transparent;
      border: 1.5px solid var(--border);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .feedback-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .feedback-btn.selected {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .feedback-comment {
      display: none;
      margin-top: 8px;
    }

    .feedback-comment.visible {
      display: flex;
      gap: 8px;
    }

    .feedback-comment input {
      flex: 1;
      min-width: 0;
      font-family: inherit;
      font-size: 0.85rem;
      padding: 8px 12px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      background: var(--card);
    }

    .feedback-comment input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .feedback-comment button {
      flex-shrink: 0;
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 8px 14px;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .feedback-thanks {
      display: none;
      font-size: 0.85rem;
      color: var(--accent);
      font-weight: 500;
    }

    .feedback-thanks.visible {
      display: block;
    }

    .coaching-note {
      display: none;
      margin-top: 14px;
      padding: 14px 16px;
      background: #f0f7f8;
      border-radius: 8px;
      border-left: 3px solid var(--accent);
      font-size: 0.88rem;
      font-style: italic;
      color: var(--text-light);
      line-height: 1.55;
    }

    .coaching-note.visible {
      display: block;
    }

    /* ── Mode Toggle ── */
    .mode-toggle {
      display: flex;
      gap: 0;
      margin-top: 20px;
      border-radius: 8px;
      overflow: hidden;
      border: 1.5px solid var(--border);
    }

    .mode-btn {
      flex: 1;
      padding: 10px 16px;
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-light);
      background: var(--card);
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .mode-btn.active {
      background: var(--accent);
      color: #fff;
    }

    .mode-btn:not(.active):hover {
      background: #f0f4f7;
    }

    /* ── Context Field ── */
    .context-toggle {
      margin-top: 10px;
    }

    .link-btn {
      font-family: inherit;
      font-size: 0.85rem;
      color: var(--text-light);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 0;
      transition: color 0.2s;
    }

    .link-btn:hover {
      color: var(--accent);
    }

    .context-field {
      margin-top: 8px;
    }

    .context-field textarea {
      min-height: 80px;
      font-size: 0.9rem;
    }

    .context-field label {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-light);
    }

    /* ── Options Panel ── */
    .options-toggle {
      margin-top: 12px;
      text-align: center;
    }

    .options-panel {
      margin-top: 12px;
      padding: 16px;
      background: #f7fafb;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .options-panel .field + .field {
      margin-top: 14px;
    }

    /* ── Short Reply Checkbox ── */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    /* ── Interpret Placeholder ── */
    .interpret-placeholder {
      margin-top: 24px;
    }

    .interpret-placeholder .output-text {
      color: var(--text-light);
      font-style: italic;
    }

    .response-disclaimer {
      font-size: 0.78rem;
      color: var(--text-light);
      margin-top: 10px;
      font-style: italic;
    }

  </style>
</head>
<body>

  <!-- ── Header ── -->
  <header>
    <h1>CalmReply</h1>
    <p>Handles the conversations you've been avoiding.</p>
  </header>

  <!-- ── Main Card ── -->
  <div class="card">

    <!-- Message Input -->
    <div class="field">
      <label for="message" id="messageLabel">Paste what you received, or describe the situation</label>
      <textarea id="message" rows="6" placeholder="Paste the message you've been avoiding, or describe who you need to reach out to"></textarea>
    </div>

    <!-- Collapsible Context Field -->
    <div class="context-toggle" id="contextToggle">
      <button type="button" id="contextBtn" class="link-btn">+ Add a note (optional)</button>
    </div>
    <div class="context-field" id="contextField" style="display:none;">
      <label for="contextInput" id="contextLabel">Add a note (optional)</label>
      <textarea id="contextInput" rows="3" placeholder="What you want to say, your goal, any constraints..."></textarea>
    </div>

    <!-- Mode Toggle -->
    <div class="mode-toggle" id="modeToggle">
      <button type="button" class="mode-btn active" data-mode="reply" id="modeReply">Reply Mode</button>
      <button type="button" class="mode-btn" data-mode="interpret" id="modeInterpret">Interpret Mode</button>
    </div>

    <!-- Submit -->
    <button class="btn-primary" id="submitBtn" type="button">Help me respond</button>

    <!-- Options Expander -->
    <div class="options-toggle" id="optionsToggle">
      <button type="button" id="optionsBtn" class="link-btn">Options</button>
    </div>
    <div class="options-panel" id="optionsPanel" style="display:none;">
      <div class="field">
        <label for="situation">Situation</label>
        <select id="situation">
          <option value="avoiding">I've Been Avoiding This</option>
          <option value="complaint">Complaint / De-escalation</option>
          <option value="ghosted">Ghosted Follow-Up</option>
          <option value="invoice">Invoice Chase</option>
          <option value="scope">Scope Pushback / Saying No</option>
          <option value="awkward">Awkward or Difficult Message</option>
          <option value="general">General Communication Help</option>
        </select>
      </div>
      <div class="field">
        <label>Tone</label>
        <div class="tone-options">
          <label class="tone-pill">
            <input type="radio" name="tone" value="softer" checked />
            <span>Softer</span>
          </label>
          <label class="tone-pill">
            <input type="radio" name="tone" value="firmer" />
            <span>Firmer</span>
          </label>
        </div>
      </div>
      <div class="field">
        <label class="checkbox-label">
          <input type="checkbox" id="shortReply" />
          <span>Short reply only</span>
        </label>
      </div>
    </div>

    <!-- Error -->
    <div class="error-msg" id="errorMsg">Something went wrong. Try again in a moment.</div>

    <!-- Interpret Mode Placeholder -->
    <div class="interpret-placeholder" id="interpretPlaceholder" style="display:none;">
      <div class="output-section visible">
        <div class="output-label">Interpret Mode</div>
        <div class="output-text">Coming soon. For now, use Reply Mode to get a response you can send.</div>
      </div>
    </div>

    <!-- Output -->
    <div class="output-section" id="outputSection">
      <div class="output-label">Your suggested response</div>
      <div class="output-text" id="outputText"></div>
      <div class="coaching-note" id="coachingNote"></div>
      <button class="btn-copy" id="copyBtn" type="button">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="5.5" y="5.5" width="8" height="8" rx="1.5"/><path d="M10.5 5.5V3.5a1.5 1.5 0 0 0-1.5-1.5H3.5A1.5 1.5 0 0 0 2 3.5V9a1.5 1.5 0 0 0 1.5 1.5h2"/></svg>
        <span id="copyLabel">Copy to clipboard</span>
      </button>
      <p class="response-disclaimer">Always review and personalise before sending.</p>

      <!-- Feedback -->
      <div class="feedback-section" id="feedbackSection">
        <div class="feedback-prompt">Was this response helpful?</div>
        <div class="feedback-buttons">
          <button class="feedback-btn" data-rating="helpful" type="button">&#128077; Helpful</button>
          <button class="feedback-btn" data-rating="not_helpful" type="button">&#128078; Not quite</button>
        </div>
        <div class="feedback-comment" id="feedbackComment">
          <input type="text" id="feedbackInput" placeholder="What could be better?" maxlength="200" />
          <button type="button" id="feedbackSend">Send</button>
        </div>
        <div class="feedback-thanks" id="feedbackThanks">Thanks for the feedback.</div>
      </div>
    </div>
  </div>

  <!-- ── Email Capture ── -->
  <div class="email-section">
    <p>I'm building this because I'm AuDHD and needed it. Want to follow along?</p>
    <form class="email-form" id="emailForm">
      <input type="email" id="emailInput" placeholder="you@email.com" required />
      <button type="submit">Keep me posted</button>
    </form>
    <div class="email-confirm" id="emailConfirm">Thanks — I'll keep you in the loop.</div>
  </div>

  <!-- ── Footer ── -->
  <footer>
    <p>Built by a paramedic with AuDHD who got tired of freezing.</p>
  </footer>

  <!-- Vercel Analytics -->
  <script defer src="/_vercel/insights/script.js"></script>

  <!-- ── JS ── -->
  <script>
    (function () {
      // ── Config ──
      var WEBHOOK_URL = 'https://aswales.app.n8n.cloud/webhook/calmreply';
      var TRACK_URL = 'https://aswales.app.n8n.cloud/webhook/calmreply-track';
      var EMAIL_WEBHOOK_URL = 'https://aswales.app.n8n.cloud/webhook/calmreply-email';

      // ── Elements ──
      var situationEl = document.getElementById('situation');
      var messageEl = document.getElementById('message');
      var messageLabel = document.getElementById('messageLabel');
      var submitBtn = document.getElementById('submitBtn');
      var outputSection = document.getElementById('outputSection');
      var outputText = document.getElementById('outputText');
      var copyBtn = document.getElementById('copyBtn');
      var copyLabel = document.getElementById('copyLabel');
      var errorMsg = document.getElementById('errorMsg');
      var emailForm = document.getElementById('emailForm');
      var emailInput = document.getElementById('emailInput');
      var emailConfirm = document.getElementById('emailConfirm');
      var feedbackSection = document.getElementById('feedbackSection');
      var feedbackComment = document.getElementById('feedbackComment');
      var feedbackInput = document.getElementById('feedbackInput');
      var feedbackSend = document.getElementById('feedbackSend');
      var feedbackThanks = document.getElementById('feedbackThanks');
      var feedbackBtns = document.querySelectorAll('.feedback-btn');
      var coachingNote = document.getElementById('coachingNote');
      var contextBtn = document.getElementById('contextBtn');
      var contextField = document.getElementById('contextField');
      var contextInput = document.getElementById('contextInput');
      var contextLabel = document.getElementById('contextLabel');
      var contextToggle = document.getElementById('contextToggle');
      var modeReply = document.getElementById('modeReply');
      var modeInterpret = document.getElementById('modeInterpret');
      var optionsBtn = document.getElementById('optionsBtn');
      var optionsPanel = document.getElementById('optionsPanel');
      var shortReply = document.getElementById('shortReply');
      var interpretPlaceholder = document.getElementById('interpretPlaceholder');

      // ── State ──
      var currentMode = 'reply';
      var currentRequestId = null;

      var placeholders = {
        reply: {
          avoiding: 'Paste the message you\'ve been avoiding, or describe who you need to reach out to',
          default: 'Paste the message here, or describe what you need to say...'
        },
        interpret: {
          default: 'Paste the message you want help understanding'
        }
      };

      function getSelectedTone() {
        var checked = document.querySelector('input[name="tone"]:checked');
        return checked ? checked.value : 'softer';
      }

      function getDeviceType() {
        return window.innerWidth <= 768 ? 'mobile' : 'desktop';
      }

      function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
      }

      function track(data) {
        try {
          fetch(TRACK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          }).catch(function () {});
        } catch (e) {}
      }

      function bump(key) {
        var k = 'calmreply_count_' + key;
        try { localStorage.setItem(k, (parseInt(localStorage.getItem(k) || '0', 10) + 1).toString()); } catch (e) {}
      }

      function lsGet(key) {
        try { return localStorage.getItem('calmreply_' + key); } catch (e) { return null; }
      }
      function lsSet(key, val) {
        try { localStorage.setItem('calmreply_' + key, val); } catch (e) {}
      }

      function updatePlaceholder() {
        if (currentMode === 'interpret') {
          messageEl.placeholder = placeholders.interpret.default;
        } else {
          messageEl.placeholder = situationEl.value === 'avoiding'
            ? placeholders.reply.avoiding
            : placeholders.reply.default;
        }
      }

      function updateModeUI() {
        if (currentMode === 'reply') {
          modeReply.classList.add('active');
          modeInterpret.classList.remove('active');
          submitBtn.textContent = 'Help me respond';
          messageLabel.textContent = 'Paste what you received, or describe the situation';
          contextLabel.textContent = 'Add a note (optional)';
        } else {
          modeInterpret.classList.add('active');
          modeReply.classList.remove('active');
          submitBtn.textContent = 'Help me understand this';
          messageLabel.textContent = 'Paste the message you want help understanding';
          contextLabel.textContent = 'Anything you want me to consider when interpreting this? (optional)';
        }
        updatePlaceholder();
      }

      function showContext() {
        contextField.style.display = 'block';
        contextToggle.style.display = 'none';
        lsSet('context_expanded', 'true');
      }

      function toggleOptions() {
        var visible = optionsPanel.style.display !== 'none';
        if (!visible) bump('options_opened');
        optionsPanel.style.display = visible ? 'none' : 'block';
        optionsBtn.textContent = visible ? 'Options' : 'Hide options';
        lsSet('options_expanded', visible ? 'false' : 'true');
      }

      // Restore localStorage state
      if (lsGet('context_expanded') === 'true' || lsGet('context_used') === 'true') {
        showContext();
      }
      if (lsGet('options_expanded') === 'true') {
        optionsPanel.style.display = 'block';
        optionsBtn.textContent = 'Hide options';
      }

      // Event Listeners
      contextBtn.addEventListener('click', showContext);
      modeReply.addEventListener('click', function () {
        currentMode = 'reply';
        updateModeUI();
      });
      modeInterpret.addEventListener('click', function () {
        currentMode = 'interpret';
        updateModeUI();
      });
      optionsBtn.addEventListener('click', toggleOptions);
      situationEl.addEventListener('change', updatePlaceholder);

      // Submit Handler
      submitBtn.addEventListener('click', function () {
        var message = messageEl.value.trim();
        if (!message) {
          messageEl.focus();
          return;
        }

        bump('generate_clicked');

        if (currentMode === 'interpret') {
          outputSection.classList.remove('visible');
          interpretPlaceholder.style.display = 'block';
          interpretPlaceholder.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          return;
        }

        var contextText = contextInput ? contextInput.value.trim() : '';
        if (contextText) {
          lsSet('context_used', 'true');
        }

        errorMsg.classList.remove('visible');
        outputSection.classList.remove('visible');
        interpretPlaceholder.style.display = 'none';
        coachingNote.classList.remove('visible');
        feedbackSection.classList.remove('visible');
        feedbackComment.classList.remove('visible');
        feedbackThanks.classList.remove('visible');
        feedbackBtns.forEach(function (btn) { btn.classList.remove('selected'); });
        submitBtn.disabled = true;
        submitBtn.textContent = 'Finding the right words\u2026';

        currentRequestId = generateId();
        var situationType = situationEl.value;
        var tone = getSelectedTone();

        var userMessage = message;
        if (contextText) {
          userMessage += '\n\n[USER CONTEXT: ' + contextText + ']';
        }
        if (shortReply.checked) {
          userMessage += '\n\n[SHORT REPLY MODE: Write a reply of 40 words or fewer. One paragraph. Must contain an acknowledgment and a clear action or ask. Hard cap 60 words. No filler, no sign-offs unless the input had one.]';
        }

        var payload = {
          situationType: situationType,
          userMessage: userMessage,
          tone: tone
        };

        var controller = new AbortController();
        var timeout = setTimeout(function () { controller.abort(); }, 15000);

        fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal
        })
          .then(function (res) {
            clearTimeout(timeout);
            if (!res.ok) throw new Error('Server error');
            return res.json();
          })
          .then(function (data) {
            var result = Array.isArray(data) ? data[0] : data;
            if (!result || !result.response) throw new Error('Empty response');

            var fullResponse = result.response;
            coachingNote.classList.remove('visible');
            coachingNote.textContent = '';

            if (situationType === 'avoiding' && fullResponse.indexOf('\n---\n') !== -1) {
              var parts = fullResponse.split('\n---\n');
              outputText.textContent = parts[0].trim();
              coachingNote.textContent = parts.slice(1).join('\n---\n').trim();
              coachingNote.classList.add('visible');
            } else {
              outputText.textContent = fullResponse;
            }

            outputSection.classList.add('visible');
            feedbackSection.classList.add('visible');
            outputSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            track({
              event: 'generation',
              requestId: currentRequestId,
              timestamp: new Date().toISOString(),
              situationType: situationType,
              tone: tone,
              mode: currentMode,
              shortReply: shortReply.checked,
              contextProvided: contextText.length > 0,
              device: getDeviceType(),
              inputLength: message.length,
              outputWords: result.response.split(/\s+/).length
            });
          })
          .catch(function () {
            errorMsg.classList.add('visible');
            track({
              event: 'error',
              requestId: currentRequestId,
              timestamp: new Date().toISOString(),
              situationType: situationType,
              tone: tone,
              device: getDeviceType()
            });
          })
          .finally(function () {
            submitBtn.disabled = false;
            submitBtn.textContent = currentMode === 'reply' ? 'Help me respond' : 'Help me understand this';
          });
      });

      // Feedback
      feedbackBtns.forEach(function (btn) {
        btn.addEventListener('click', function () {
          var rating = btn.getAttribute('data-rating');
          feedbackBtns.forEach(function (b) { b.classList.remove('selected'); });
          btn.classList.add('selected');

          if (rating === 'not_helpful') {
            feedbackComment.classList.add('visible');
            feedbackInput.focus();
          } else {
            feedbackComment.classList.remove('visible');
            track({
              event: 'feedback',
              requestId: currentRequestId,
              timestamp: new Date().toISOString(),
              rating: rating,
              comment: ''
            });
            setTimeout(function () {
              feedbackSection.innerHTML = '';
              feedbackThanks.classList.add('visible');
              feedbackSection.appendChild(feedbackThanks);
            }, 300);
          }
        });
      });

      feedbackSend.addEventListener('click', function () {
        var comment = feedbackInput.value.trim();
        track({
          event: 'feedback',
          requestId: currentRequestId,
          timestamp: new Date().toISOString(),
          rating: 'not_helpful',
          comment: comment
        });
        feedbackComment.classList.remove('visible');
        feedbackBtns.forEach(function (b) { b.style.display = 'none'; });
        feedbackThanks.classList.add('visible');
      });

      // Copy
      copyBtn.addEventListener('click', function () {
        var text = outputText.textContent;
        if (!text) return;
        bump('copy_clicked');

        navigator.clipboard.writeText(text).then(function () {
          copyBtn.classList.add('copied');
          copyLabel.textContent = 'Copied \u2713';
          track({
            event: 'copy',
            requestId: currentRequestId,
            timestamp: new Date().toISOString()
          });
          setTimeout(function () {
            copyBtn.classList.remove('copied');
            copyLabel.textContent = 'Copy to clipboard';
          }, 2000);
        });
      });

      // Email
      emailForm.addEventListener('submit', function (e) {
        e.preventDefault();
        var email = emailInput.value.trim();
        if (!email) return;

        fetch(EMAIL_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email })
        })
          .then(function () {
            emailForm.style.display = 'none';
            emailConfirm.classList.add('visible');
            track({ event: 'email_signup', timestamp: new Date().toISOString() });
          })
          .catch(function () {
            emailForm.style.display = 'none';
            emailConfirm.classList.add('visible');
          });
      });

      // Init
      updateModeUI();
      track({
        event: 'pageview',
        timestamp: new Date().toISOString(),
        device: getDeviceType(),
        referrer: document.referrer || 'direct'
      });
    })();
  </script>
</body>
</html>
